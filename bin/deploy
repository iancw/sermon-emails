CONFIG_BUCKET=$1
CODE_BUCKET=$2

if [ $# -ne 2 ]
then
    echo "Usage: deploy <config-bucket> <deploy-bucket>"
    echo " (If you can't remember the exact name of your buckets, run 'aws s3 ls')"
    exit 1
fi

echo "Deleting existing build folder..."
rm -rf build/
echo "Copying files to build dir"
mkdir build
cp js/*.js build
cp package.json build/
rsync -r styles build/
for y in config/*.yml
do
  echo "Converting $y to json"
  z=${y#config/}
  yaml2json "$y" > "build/${z%.yml}.json"
done
cd build
rm *.test.js
echo "Fetching configuration from $CONFIG_BUCKET in S3..."
aws s3 s3://$CONFIG_BUCKET .
echo "Installing production deps in build"
npm install --only=production
echo "Syncing code to $CODE_BUCKET bucket in S3..."
aws s3 sync . s3://$CODE_BUCKET
cd ..
